name: Build

permissions:
  contents: read

on: 
  pull_request:
    #types: [opened, synchronize, reopened, closed, edited, ready_for_review, labeled, unlabeled]
    branches:
      - main
      - feature/*
  # When create a tag
  push:
    tags:
    - '*'
  workflow_dispatch:
    inputs:

env:
  NODE_VERSION: '20'

jobs:
  
  ### COMMONS ###
  extract_commitid_or_tag_name:
    runs-on: ubuntu-latest
    outputs:
      commitid_or_tag_name: ${{ steps.extract.outputs.commitid_or_tag_name }}
    steps:
      - id: extract
        name: Compute tag name or commit id
        run: |
          if ( [ "tag" == "${{ github.ref_type }}"] ) then
            tag_name=$( basename "${{github.ref_name}}" )
            echo "commitid_or_tag_name=${tag_name}" >> $GITHUB_OUTPUT
          else
            echo "commitid_or_tag_name=${{github.sha}}" >> $GITHUB_OUTPUT
          fi
  
  
  ###### DOCKER LAMBDAS JOBS ###
  list_docker_lambdas:
    runs-on: ubuntu-latest
    outputs:
      lambdas: ${{ steps.extract.outputs.lambdas }}
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      - id: extract
        name: List Dockerfile lambdas folders
        run: |
          PACKAGES=$( 
              find lambdas -type f -name "Dockerfile" -exec dirname {} \; \
                | jq -cnR '[inputs]' \
                | jq -c 'map( { "name": (.| sub(".*/";"")), "folder": .})' \
              )
          echo "Docker lambdas"
          echo "$PACKAGES"
          echo "lambdas=$PACKAGES" >> $GITHUB_OUTPUT
  
  docker_build_and_push:
    name: Docker ${{ matrix.lambda.name }}
    needs: [ list_docker_lambdas, extract_commitid_or_tag_name ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        lambda: ${{ fromJson(needs.list_docker_lambdas.outputs.lambdas) }}
    env: 
      source_tag: ${{ needs.extract_commitid_or_tag_name.outputs.commitid_or_tag_name  }}
    steps:
      - name: Announce
        run: echo "Start build docker image for project ${{ matrix.project.folder }} source version ${{ env.source_tag }}"



  ###### NODES LAMBDAS JOBS ###
  list_node_lambdas:
    runs-on: ubuntu-latest
    outputs:
      lambdas: ${{ steps.extract.outputs.lambdas }}
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      - id: extract
        name: List node lambdas folders
        run: |
          PACKAGES=$( 
              find lambdas -type f -name "package.json" -exec dirname {} \; \
                | jq -cnR '[inputs]' \
                | jq -c 'map( { "name": (.| sub(".*/";"")), "folder": .})' \
              )
          echo "Node lambdas"
          echo "$PACKAGES"
          echo "lambdas=$PACKAGES" >> $GITHUB_OUTPUT
  
  node_build_and_upload_artifact:
    name: Node ${{ matrix.lambda.name }}
    needs: [ list_node_lambdas, extract_commitid_or_tag_name ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        lambda: ${{ fromJson(needs.list_node_lambdas.outputs.lambdas) }}
    env: 
      source_tag: ${{ needs.extract_commitid_or_tag_name.outputs.commitid_or_tag_name  }}
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      - id: check_dockerfile_presence
        name: Check Dockerfile presence
        run: |
          if ( [ -e "${{ matrix.lambda.folder }}/Dockerfile" ] ) then
            has_dockerfile="true"
          else
            has_dockerfile="false"
          fi
          echo "Dockerfile founded? ${has_dockerfile}"
          echo "has_dockerfile=$has_dockerfile" >> $GITHUB_OUTPUT
      - name: Gracefully exit if Dockerfile is present
        if: ${{ steps.check_dockerfile_presence.outputs.has_dockerfile }}
        run: exit 79
      - name: Announce
        run: |
          echo "Start build docker image for project ${{ matrix.project.folder }} source version ${{ env.source_tag }}"
          echo "Has Dockerfile? ${{steps.check_dockerfile_presence.outputs.has_dockerfile}}"

      

  # build-all-projects:
  #   name: Lint, build, and archive all node projects
  #   runs-on: ubuntu-latest
  #   needs: extract-ref
  #   env: 
  #     artifact_suffix: |
  #       ${{ 
  #         github.ref_type == 'branch' 
  #         && format('{0}_{1}', needs.extract-ref.outputs.ref_simple_name, github.sha )
  #         || needs.extract-ref.outputs.ref_simple_name 
  #       }}

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
  #     - name: Setup Node.js
  #       uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}

  #     - name: Compile and package all lambdas
  #       run: |
  #         pwd
  #         mkdir zips
  #         zips_folder=$( cd zips && pwd)
  #         echo " - Destination folder for archives is ${zips_folder}"

  #         projects=$( find ./ -name "package.json" -and -not -path "*/node_modules/*" )
  #         for prj_file in ${projects} ; do
  #           prj_dir=$( dirname $prj_file )
  #           prj_name=$( cat ${prj_file} | jq -r '.name' )
            
  #           echo ""
  #           echo ""
  #           echo " === NODE PROJECT ${prj_name} IN ${prj_dir}"
  #           echo " ===================================================================="
      
  #           if ( [ -f "${prj_dir}/Dockerfile" ] ) then
  #             echo " === Start DOCKER build"
  #             (
  #               echo ""
  #               echo " - Enter into project folder"
  #               cd ${prj_dir} 
  #               pwd 

  #               echo ""
  #               echo " - Lint node code (if configured)"
  #               npm ci
  #               npm run --if-present lint

  #               docker build -t ${prj_name} .
  #             )
  #           else 
  #             echo " === Start NPM build"
  #             (
  #               echo ""
  #               echo " - Enter into project folder"
  #               cd ${prj_dir} 
  #               pwd 

  #               echo ""
  #               echo " - Download dependencies"
  #               npm ci 

  #               echo ""
  #               echo " - Build project"
  #               npm run --if-present lint
  #               npm run build 

  #               echo ""
  #               echo " - Package project code"
  #               (cd dist && zip -q -r "${zips_folder}/${prj_name}.zip" *) 

  #               echo ""
  #               echo " - Package runtime libraries"
  #               mkdir nodejs 
  #               cp package.json package-lock.json nodejs 
  #               NODE_ENV=production npm ci --prefix nodejs 
  #               zip -q -r "${zips_folder}/${prj_name}-liblayer.zip" nodejs 
  #           )
  #           fi
  #         done

  #         echo ""
  #         echo " - Produced Docker images"
  #         docker images

  #         echo ""
  #         echo " - Produced Zip Archives ${zips_folder} "
  #         ls -1 "${zips_folder}"
  #     - name: Upload Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: all_lambdas__${{ env.artifact_suffix }}
  #         path: zips/*.zip
  # create_draft_release:
  #   if: github.ref_type == 'tag'
  #   name: Create Draft Release
  #   runs-on: ubuntu-latest
  #   needs: [ extract-ref, build-all-projects ]
  #   env:
  #     artifact_suffix: ${{ needs.extract-ref.outputs.ref_simple_name }}
  #   steps:
  #     - name: Download a single artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: all_lambdas__${{ env.artifact_suffix }}
  #         path: released_files
  #     - name: Create draft release
  #       env:
  #         GH_TOKEN: ${{ github.token }}
  #       run: |
  #         gh -R ${{ github.repository }} release create -d \
  #            --verify-tag ${{github.ref_name}} \
  #            -t ${{github.ref_name}} \
  #            released_files/*

